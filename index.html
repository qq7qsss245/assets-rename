<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批量重命名工具</title>
  <!-- Bootstrap CSS -->
  <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      padding-top: 20px;
      padding-bottom: 40px;
      background-color: #f8f9fa;
    }
    .file-item {
      margin-bottom: 5px;
    }
    .result-success {
      color: #198754;
    }
    .result-error {
      color: #dc3545;
    }
    .dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item-text {
      word-break: break-all;
    }
    .input-group .dropdown-toggle {
      border-left: none;
    }
    
    /* 拖拽区域样式 */
    .drop-zone {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      transition: all 0.3s ease;
      min-height: 200px;
      position: relative;
    }
    
    .drop-zone.drag-over {
      border-color: #0d6efd;
      background-color: rgba(13, 110, 253, 0.1);
      border-style: solid;
    }
    
    .drop-zone-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 2rem;
      text-align: center;
    }
    
    .drop-zone-icon {
      font-size: 3rem;
      color: #6c757d;
      margin-bottom: 1rem;
      transition: color 0.3s ease;
    }
    
    .drop-zone.drag-over .drop-zone-icon {
      color: #0d6efd;
    }
    
    .drop-zone-text {
      color: #6c757d;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .drop-zone.drag-over .drop-zone-text {
      color: #0d6efd;
      font-weight: 500;
    }
    
    .drop-zone-hint {
      color: #adb5bd;
      font-size: 0.9rem;
    }
    
    .drop-zone.drag-over .drop-zone-hint {
      color: #0d6efd;
    }
    
    /* 预览表格样式 */
    .preview-filename {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      word-break: break-all;
      line-height: 1.3;
    }
    
    .preview-status-success {
      color: #198754;
    }
    
    .preview-status-error {
      color: #dc3545;
    }
    
    .preview-loading {
      color: #6c757d;
    }
    
    .table th {
      position: sticky;
      top: 0;
      background-color: #212529 !important;
      z-index: 10;
    }
    
    /* 文件状态样式 */
    .file-status-pending {
      color: #6c757d;
    }
    
    .file-status-processing {
      color: #0d6efd;
    }
    
    .file-status-success {
      color: #198754;
    }
    
    .file-status-error {
      color: #dc3545;
    }
    
    .file-status-conflict {
      color: #fd7e14;
    }
    
    /* 文件行选中状态 */
    .file-row-selected {
      background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    /* 字段验证状态 */
    .field-valid {
      border-color: #198754;
    }
    
    .field-invalid {
      border-color: #dc3545;
    }
    
    .field-warning {
      border-color: #fd7e14;
    }
    
    /* 进度条动画 */
    .progress-bar-animated {
      animation: progress-bar-stripes 1s linear infinite;
    }
    
    /* 工具提示样式 */
    .tooltip-inner {
      max-width: 300px;
      text-align: left;
    }
    
    /* 批量操作工具栏 */
    #batch-toolbar {
      border: 1px solid #dee2e6;
      transition: all 0.3s ease;
    }
    
    #batch-toolbar.show {
      display: flex !important;
    }
    
    /* 文件名冲突高亮 */
    .conflict-highlight {
      background-color: rgba(255, 193, 7, 0.2);
      border-left: 3px solid #ffc107;
      padding-left: 8px;
    }
    
    /* 加载动画 */
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 响应式优化 */
    @media (max-width: 768px) {
      .preview-filename {
        font-size: 0.75rem;
      }
      
      .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      
      #batch-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      #batch-toolbar .d-flex {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 标题区域 -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="bg-primary text-white p-3 rounded shadow-sm">
          <h1 class="display-6">欢迎使用批量重命名工具</h1>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- 左侧表单区域 -->
      <div class="col-md-5">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <h5 class="card-title mb-0">重命名参数</h5>
          </div>
          <div class="card-body">
            <form id="rename-form">
              <div class="mb-3">
                <label for="product" class="form-label">产品名：</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="product" required>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-field="product" aria-expanded="false">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <ul class="dropdown-menu" id="product-dropdown">
                    <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                  </ul>
                </div>
              </div>
              <div class="mb-3">
                <label for="template" class="form-label">模板名：</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="template" required>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-field="template" aria-expanded="false">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <ul class="dropdown-menu" id="template-dropdown">
                    <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                  </ul>
                </div>
              </div>
              <div class="mb-3">
                <label for="video" class="form-label">视频名：</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="video" required>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-field="video" aria-expanded="false">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <ul class="dropdown-menu" id="video-dropdown">
                    <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                  </ul>
                </div>
              </div>
              <div class="mb-3">
                <label for="author" class="form-label">制作人：</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="author" required>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-field="author" aria-expanded="false">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <ul class="dropdown-menu" id="author-dropdown">
                    <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                  </ul>
                </div>
              </div>
              <div class="mb-3">
                <label for="duration" class="form-label">制作时长（小时）：</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="duration" required>
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-field="duration" aria-expanded="false">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <ul class="dropdown-menu" id="duration-dropdown">
                    <li><span class="dropdown-item text-muted">暂无历史记录</span></li>
                  </ul>
                </div>
                <div class="form-text">请输入制作该视频所花费的时间（小时）</div>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="useNumberSuffix">
                  <label class="form-check-label" for="useNumberSuffix">
                    启用数字后缀序号（重名时添加2、3、4等后缀）
                  </label>
                </div>
                <small class="form-text text-muted">
                  勾选：Test → Test2、Test3、Test4<br>
                  不勾选：Test → Test(1)、Test(2)、Test(3)
                </small>
              </div>
            </form>
          </div>
          <div class="card-footer">
            <div class="d-grid gap-2">
              <button id="select-files" class="btn btn-primary">
                <i class="bi bi-folder2-open me-2"></i>选择文件
              </button>
              <button id="clear-fields" class="btn btn-outline-secondary">
                <i class="bi bi-eraser me-2"></i>清空所有字段
              </button>
              <button id="rename-files" class="btn btn-success">
                <i class="bi bi-check-circle me-2"></i>确认重命名
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧预览界面区域 -->
      <div class="col-md-7">
        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">重命名预览</h5>
            <div class="btn-group" role="group" id="preview-controls" style="display: none;">
              <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-preview" title="刷新预览">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all" title="全选">
                <i class="bi bi-check-square"></i>
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all" title="取消全选">
                <i class="bi bi-square"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="preview-container" class="overflow-auto" style="max-height: 400px;">
              <!-- 默认状态：拖拽区域 -->
              <div id="drop-zone" class="drop-zone">
                <div class="drop-zone-content">
                  <i class="bi bi-cloud-upload drop-zone-icon"></i>
                  <div class="drop-zone-text">拖拽视频文件到此处</div>
                  <div class="drop-zone-hint">或点击"选择文件"按钮</div>
                  <div class="drop-zone-hint mt-2">
                    <small>支持格式：MP4、MOV、AVI、MKV、FLV、WMV、WEBM</small>
                  </div>
                </div>
              </div>
              
              <!-- 预览表格 -->
              <div id="preview-table" class="d-none">
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead class="table-dark">
                      <tr>
                        <th style="width: 5%">
                          <input type="checkbox" class="form-check-input" id="select-all-checkbox" title="全选/取消全选">
                        </th>
                        <th style="width: 40%">原文件名</th>
                        <th style="width: 40%">预览新文件名</th>
                        <th style="width: 10%">状态</th>
                        <th style="width: 5%">操作</th>
                      </tr>
                    </thead>
                    <tbody id="preview-table-body">
                      <!-- 预览数据将在这里动态生成 -->
                    </tbody>
                  </table>
                </div>
                
                <!-- 批量操作工具栏 -->
                <div class="d-flex justify-content-between align-items-center mt-3 p-2 bg-light rounded" id="batch-toolbar" style="display: none !important;">
                  <div class="d-flex align-items-center">
                    <span class="text-muted me-3">已选择 <span id="selected-count">0</span> 个文件</span>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-success" id="batch-rename" disabled>
                        <i class="bi bi-check-circle me-1"></i>重命名选中文件
                      </button>
                      <button type="button" class="btn btn-outline-warning" id="batch-retry" disabled>
                        <i class="bi bi-arrow-clockwise me-1"></i>重试失败文件
                      </button>
                    </div>
                  </div>
                  <div class="text-muted small">
                    <span id="status-summary"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 底部信息 -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="alert alert-info">
          <small>第二阶段功能：批量操作、状态管理、进度显示、错误处理优化已完成。</small>
        </div>
      </div>
    </div>
  </div>

  <!-- 进度显示模态框 -->
  <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="progressModalLabel">
            <i class="bi bi-gear-fill me-2"></i>正在重命名文件
          </h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span>总体进度</span>
              <span id="progress-text">0 / 0</span>
            </div>
            <div class="progress mb-3">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                   id="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <strong>当前处理：</strong>
            <div id="current-file" class="text-muted">准备开始...</div>
          </div>
          
          <div class="mb-3">
            <div class="row">
              <div class="col-4 text-center">
                <div class="text-success h4" id="success-count">0</div>
                <small class="text-muted">成功</small>
              </div>
              <div class="col-4 text-center">
                <div class="text-danger h4" id="error-count">0</div>
                <small class="text-muted">失败</small>
              </div>
              <div class="col-4 text-center">
                <div class="text-info h4" id="remaining-count">0</div>
                <small class="text-muted">剩余</small>
              </div>
            </div>
          </div>
          
          <!-- 详细日志 -->
          <div class="accordion" id="logAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="logHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#logCollapse" aria-expanded="false" aria-controls="logCollapse">
                  <i class="bi bi-list-ul me-2"></i>详细日志
                </button>
              </h2>
              <div id="logCollapse" class="accordion-collapse collapse" aria-labelledby="logHeading"
                   data-bs-parent="#logAccordion">
                <div class="accordion-body">
                  <div id="progress-log" class="small" style="max-height: 200px; overflow-y: auto;">
                    <!-- 日志内容 -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancel-operation" disabled>
            <i class="bi bi-x-circle me-1"></i>取消操作
          </button>
          <button type="button" class="btn btn-primary" id="close-progress" style="display: none;">
            <i class="bi bi-check-circle me-1"></i>完成
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认对话框 -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">
            <i class="bi bi-question-circle me-2"></i>确认重命名操作
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>注意：</strong>此操作将重命名选中的文件，操作不可撤销。
          </div>
          <div id="confirm-summary">
            <!-- 操作摘要 -->
          </div>
          <div class="mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirm-checkbox">
              <label class="form-check-label" for="confirm-checkbox">
                我确认要执行此重命名操作
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirm-rename" disabled>
            <i class="bi bi-check-circle me-1"></i>确认重命名
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 文件名冲突检测结果模态框 -->
  <div class="modal fade" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="conflictModalLabel">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>文件名冲突检测
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <strong>发现文件名冲突！</strong>以下文件将会产生相同的文件名：
          </div>
          <div id="conflict-list">
            <!-- 冲突列表 -->
          </div>
          <div class="mt-3">
            <p class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              系统将自动为冲突文件添加后缀以避免覆盖。
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">了解</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedFiles = [];
    let previewData = [];
    
    // 支持的视频文件扩展名
    const SUPPORTED_VIDEO_EXTENSIONS = ['mp4', 'mov', 'avi', 'mkv', 'flv', 'wmv', 'webm'];
    
    // 预览管理器类
    class PreviewManager {
      constructor() {
        this.previewContainer = document.getElementById('preview-container');
        this.dropZone = document.getElementById('drop-zone');
        this.previewTable = document.getElementById('preview-table');
        this.previewTableBody = document.getElementById('preview-table-body');
        this.previewControls = document.getElementById('preview-controls');
        this.batchToolbar = document.getElementById('batch-toolbar');
        this.selectedFiles = new Set();
        this.fileStates = new Map(); // 存储文件状态
        this.conflictGroups = new Map(); // 存储冲突文件组
        this.isProcessing = false;
      }
      
      // 显示拖拽区域
      showDropZone() {
        this.dropZone.classList.remove('d-none');
        this.previewTable.classList.add('d-none');
        this.previewControls.style.display = 'none';
        this.batchToolbar.classList.remove('show');
        this.selectedFiles.clear();
        this.fileStates.clear();
        this.conflictGroups.clear();
        selectedFiles = [];
        previewData = [];
        this.updateBatchToolbar();
      }
      
      // 显示预览表格
      showPreviewTable() {
        this.dropZone.classList.add('d-none');
        this.previewTable.classList.remove('d-none');
        this.previewControls.style.display = 'block';
        this.batchToolbar.classList.add('show');
        this.updateBatchToolbar();
      }
      
      // 更新预览数据
      async updatePreview(files) {
        if (!files || files.length === 0) {
          this.showDropZone();
          return;
        }
        
        selectedFiles = files;
        this.showPreviewTable();
        
        // 显示加载状态
        this.showLoadingState(files);
        
        // 获取表单字段
        const fields = this.getFormFields();
        
        // 获取文件元数据和预览名称
        try {
          const metadata = await window.electronAPI.getFileMetadata({ filePaths: files, fields });
          previewData = metadata;
          this.renderPreviewTable(metadata);
        } catch (error) {
          console.error('获取文件元数据失败:', error);
          this.showErrorState(files, error.message);
        }
      }
      
      // 获取表单字段
      getFormFields() {
        return {
          product: document.getElementById('product').value.trim() || '产品名',
          template: document.getElementById('template').value.trim() || '模板名',
          video: document.getElementById('video').value.trim() || '视频名',
          author: document.getElementById('author').value.trim() || '制作人',
          duration: document.getElementById('duration').value.trim() || '1'
        };
      }
      
      // 显示加载状态
      showLoadingState(files) {
        let html = '';
        files.forEach((filePath, index) => {
          const fileName = filePath.split(/[/\\]/).pop();
          html += `
            <tr>
              <td class="preview-filename">${fileName}</td>
              <td class="preview-filename preview-loading">
                <i class="bi bi-hourglass-split me-2"></i>正在生成预览...
              </td>
              <td class="text-center">
                <i class="bi bi-hourglass-split text-muted"></i>
              </td>
            </tr>
          `;
        });
        this.previewTableBody.innerHTML = html;
      }
      
      // 显示错误状态
      showErrorState(files, errorMessage) {
        let html = '';
        files.forEach((filePath, index) => {
          const fileName = filePath.split(/[/\\]/).pop();
          html += `
            <tr>
              <td class="preview-filename">${fileName}</td>
              <td class="preview-filename preview-status-error">
                <i class="bi bi-exclamation-triangle me-2"></i>预览生成失败
              </td>
              <td class="text-center">
                <i class="bi bi-x-circle text-danger"></i>
              </td>
            </tr>
          `;
        });
        this.previewTableBody.innerHTML = html;
      }
      
      // 渲染预览表格
      renderPreviewTable(metadata) {
        let html = '';
        
        // 检测文件名冲突
        this.detectConflicts(metadata);
        
        metadata.forEach((item, index) => {
          const fileId = `file-${index}`;
          const isSelected = this.selectedFiles.has(fileId);
          const fileState = this.fileStates.get(fileId) || 'pending';
          
          // 状态图标和样式
          let statusIcon, statusClass, rowClass = '';
          switch (fileState) {
            case 'processing':
              statusIcon = '<div class="loading-spinner"></div>';
              statusClass = 'file-status-processing';
              break;
            case 'success':
              statusIcon = '<i class="bi bi-check-circle text-success"></i>';
              statusClass = 'file-status-success';
              break;
            case 'error':
              statusIcon = '<i class="bi bi-x-circle text-danger"></i>';
              statusClass = 'file-status-error';
              break;
            case 'conflict':
              statusIcon = '<i class="bi bi-exclamation-triangle text-warning"></i>';
              statusClass = 'file-status-conflict';
              rowClass = 'conflict-highlight';
              break;
            default:
              statusIcon = item.success
                ? '<i class="bi bi-check-circle text-success"></i>'
                : '<i class="bi bi-x-circle text-danger"></i>';
              statusClass = item.success ? 'file-status-success' : 'file-status-error';
          }
          
          if (isSelected) {
            rowClass += ' file-row-selected';
          }
          
          const previewClass = item.success ? 'preview-status-success' : 'preview-status-error';
          
          html += `
            <tr class="${rowClass}" data-file-id="${fileId}">
              <td class="text-center">
                <input type="checkbox" class="form-check-input file-checkbox"
                       data-file-id="${fileId}" ${isSelected ? 'checked' : ''}>
              </td>
              <td class="preview-filename" title="${item.originalPath || item.originalName}">
                ${item.originalName}
              </td>
              <td class="preview-filename ${previewClass}" title="${item.previewName}">
                ${item.previewName}
              </td>
              <td class="text-center ${statusClass}" title="${this.getStatusTooltip(fileState, item)}">
                ${statusIcon}
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-secondary btn-sm retry-btn"
                          data-file-id="${fileId}" title="重试" ${fileState !== 'error' ? 'style="display:none"' : ''}>
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
        
        this.previewTableBody.innerHTML = html;
        this.setupTableEventListeners();
        this.updateBatchToolbar();
        this.updateSelectAllCheckbox();
      }
      
      // 实时更新预览（当表单字段变更时）
      async refreshPreview() {
        if (selectedFiles.length === 0) return;
        
        // 显示加载状态
        this.showLoadingState(selectedFiles);
        
        // 获取表单字段
        const fields = this.getFormFields();
        
        // 重新获取预览数据
        try {
          const metadata = await window.electronAPI.getFileMetadata({ filePaths: selectedFiles, fields });
          previewData = metadata;
          this.renderPreviewTable(metadata);
        } catch (error) {
          console.error('刷新预览失败:', error);
          this.showErrorState(selectedFiles, error.message);
        }
      }
      
      // 检测文件名冲突
      detectConflicts(metadata) {
        this.conflictGroups.clear();
        const nameMap = new Map();
        
        metadata.forEach((item, index) => {
          const previewName = item.previewName;
          if (!nameMap.has(previewName)) {
            nameMap.set(previewName, []);
          }
          nameMap.get(previewName).push(index);
        });
        
        // 标记冲突文件
        nameMap.forEach((indices, name) => {
          if (indices.length > 1) {
            this.conflictGroups.set(name, indices);
            indices.forEach(index => {
              this.fileStates.set(`file-${index}`, 'conflict');
            });
          }
        });
        
        // 如果有冲突，显示冲突对话框
        if (this.conflictGroups.size > 0) {
          this.showConflictDialog();
        }
      }
      
      // 显示冲突对话框
      showConflictDialog() {
        const modal = new bootstrap.Modal(document.getElementById('conflictModal'));
        const conflictList = document.getElementById('conflict-list');
        
        let html = '';
        this.conflictGroups.forEach((indices, name) => {
          html += `
            <div class="alert alert-warning">
              <strong>文件名：</strong> ${name}<br>
              <strong>冲突文件：</strong>
              <ul class="mb-0 mt-2">
          `;
          indices.forEach(index => {
            const item = previewData[index];
            html += `<li>${item.originalName}</li>`;
          });
          html += `</ul></div>`;
        });
        
        conflictList.innerHTML = html;
        modal.show();
      }
      
      // 获取状态工具提示
      getStatusTooltip(state, item) {
        switch (state) {
          case 'pending': return '等待处理';
          case 'processing': return '正在处理...';
          case 'success': return '处理成功';
          case 'error': return `处理失败: ${item.error || '未知错误'}`;
          case 'conflict': return '文件名冲突，将自动添加后缀';
          default: return item.success ? '预览生成成功' : `预览生成失败: ${item.error || '未知错误'}`;
        }
      }
      
      // 设置表格事件监听器
      setupTableEventListeners() {
        // 文件复选框事件
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const fileId = e.target.dataset.fileId;
            if (e.target.checked) {
              this.selectedFiles.add(fileId);
            } else {
              this.selectedFiles.delete(fileId);
            }
            this.updateRowSelection(fileId, e.target.checked);
            this.updateBatchToolbar();
            this.updateSelectAllCheckbox();
          });
        });
        
        // 重试按钮事件
        document.querySelectorAll('.retry-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const fileId = e.target.closest('.retry-btn').dataset.fileId;
            this.retryFile(fileId);
          });
        });
      }
      
      // 更新行选中状态
      updateRowSelection(fileId, selected) {
        const row = document.querySelector(`tr[data-file-id="${fileId}"]`);
        if (row) {
          if (selected) {
            row.classList.add('file-row-selected');
          } else {
            row.classList.remove('file-row-selected');
          }
        }
      }
      
      // 更新批量操作工具栏
      updateBatchToolbar() {
        const selectedCount = this.selectedFiles.size;
        const totalCount = previewData.length;
        const successCount = previewData.filter((_, index) =>
          this.fileStates.get(`file-${index}`) === 'success').length;
        const errorCount = previewData.filter((_, index) =>
          this.fileStates.get(`file-${index}`) === 'error').length;
        
        // 更新选中数量
        document.getElementById('selected-count').textContent = selectedCount;
        
        // 更新状态摘要
        const statusSummary = document.getElementById('status-summary');
        statusSummary.textContent = `总计: ${totalCount} | 成功: ${successCount} | 失败: ${errorCount}`;
        
        // 更新按钮状态
        const batchRenameBtn = document.getElementById('batch-rename');
        const batchRetryBtn = document.getElementById('batch-retry');
        
        batchRenameBtn.disabled = selectedCount === 0 || this.isProcessing;
        batchRetryBtn.disabled = errorCount === 0 || this.isProcessing;
      }
      
      // 更新全选复选框状态
      updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const totalCount = previewData.length;
        const selectedCount = this.selectedFiles.size;
        
        if (selectedCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (selectedCount === totalCount) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }
      
      // 全选/取消全选
      toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const shouldSelectAll = selectAllCheckbox.checked;
        
        this.selectedFiles.clear();
        
        if (shouldSelectAll) {
          previewData.forEach((_, index) => {
            this.selectedFiles.add(`file-${index}`);
          });
        }
        
        // 更新所有复选框
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
          checkbox.checked = shouldSelectAll;
          this.updateRowSelection(checkbox.dataset.fileId, shouldSelectAll);
        });
        
        this.updateBatchToolbar();
      }
      
      // 重试单个文件
      async retryFile(fileId) {
        const index = parseInt(fileId.replace('file-', ''));
        const item = previewData[index];
        
        if (!item) return;
        
        this.fileStates.set(fileId, 'processing');
        this.updateFileStatus(fileId, 'processing');
        
        try {
          const fields = this.getFormFields();
          const metadata = await window.electronAPI.getFileMetadata({
            filePaths: [item.originalPath],
            fields
          });
          
          if (metadata && metadata[0]) {
            previewData[index] = metadata[0];
            this.fileStates.set(fileId, metadata[0].success ? 'success' : 'error');
            this.updateFileStatus(fileId, metadata[0].success ? 'success' : 'error');
          }
        } catch (error) {
          this.fileStates.set(fileId, 'error');
          this.updateFileStatus(fileId, 'error');
        }
        
        this.updateBatchToolbar();
      }
      
      // 更新单个文件状态显示
      updateFileStatus(fileId, status) {
        const row = document.querySelector(`tr[data-file-id="${fileId}"]`);
        if (!row) return;
        
        const statusCell = row.querySelector('td:nth-child(4)');
        const retryBtn = row.querySelector('.retry-btn');
        
        let statusIcon, statusClass;
        switch (status) {
          case 'processing':
            statusIcon = '<div class="loading-spinner"></div>';
            statusClass = 'file-status-processing';
            retryBtn.style.display = 'none';
            break;
          case 'success':
            statusIcon = '<i class="bi bi-check-circle text-success"></i>';
            statusClass = 'file-status-success';
            retryBtn.style.display = 'none';
            break;
          case 'error':
            statusIcon = '<i class="bi bi-x-circle text-danger"></i>';
            statusClass = 'file-status-error';
            retryBtn.style.display = 'inline-block';
            break;
        }
        
        statusCell.className = `text-center ${statusClass}`;
        statusCell.innerHTML = statusIcon;
      }
    }
    
    // 创建预览管理器实例
    const previewManager = new PreviewManager();
    
    // 历史记录管理
    const STORAGE_KEY = 'renameToolHistory';
    const fieldNames = ['product', 'template', 'video', 'author', 'duration'];
    
    // 获取历史记录
    function getHistory() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          console.error('Failed to parse history data:', e);
        }
      }
      // 返回默认结构
      return {
        product: [],
        template: [],
        video: [],
        author: [],
        duration: []
      };
    }
    
    // 保存历史记录
    function saveHistory(history) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history data:', e);
      }
    }
    
    // 添加到历史记录
    function addToHistory(fieldName, value) {
      if (!value || !value.trim()) return;
      
      const history = getHistory();
      const trimmedValue = value.trim();
      
      // 如果已存在，先移除再添加到开头
      const index = history[fieldName].indexOf(trimmedValue);
      if (index > -1) {
        history[fieldName].splice(index, 1);
      }
      
      // 添加到开头
      history[fieldName].unshift(trimmedValue);
      
      // 限制历史记录数量（最多20条）
      if (history[fieldName].length > 20) {
        history[fieldName] = history[fieldName].slice(0, 20);
      }
      
      saveHistory(history);
      updateDropdown(fieldName);
    }
    
    // 从历史记录中删除
    function removeFromHistory(fieldName, value) {
      const history = getHistory();
      const index = history[fieldName].indexOf(value);
      if (index > -1) {
        history[fieldName].splice(index, 1);
        saveHistory(history);
        updateDropdown(fieldName);
      }
    }
    
    // 更新下拉菜单
    function updateDropdown(fieldName) {
      const history = getHistory();
      const dropdown = document.getElementById(`${fieldName}-dropdown`);
      const items = history[fieldName] || [];
      
      dropdown.innerHTML = '';
      
      if (items.length === 0) {
        dropdown.innerHTML = '<li><span class="dropdown-item text-muted">暂无历史记录</span></li>';
        return;
      }
      
      items.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="dropdown-item d-flex justify-content-between align-items-center">
            <span class="history-item-text" style="cursor: pointer; flex-grow: 1;">${item}</span>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromHistory('${fieldName}', '${item}')" title="删除">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
        
        // 点击文本选择该项
        li.querySelector('.history-item-text').addEventListener('click', () => {
          document.getElementById(fieldName).value = item;
          // 关闭下拉菜单
          const dropdownToggle = document.querySelector(`[data-bs-toggle="dropdown"][data-field="${fieldName}"]`);
          const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
          if (dropdown) dropdown.hide();
        });
        
        dropdown.appendChild(li);
      });
    }
    
    // 更新文件列表显示（现在使用预览管理器）
    async function updateFileListDisplay(files) {
      await previewManager.updatePreview(files);
    }
    
    // 拖拽事件处理
    function setupDragAndDrop() {
      const fileListDiv = document.getElementById('drop-zone');
      
      // 阻止默认拖拽行为
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileListDiv.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      // 高亮拖拽区域
      ['dragenter', 'dragover'].forEach(eventName => {
        fileListDiv.addEventListener(eventName, highlight, false);
      });
      
      // 取消高亮
      ['dragleave', 'drop'].forEach(eventName => {
        fileListDiv.addEventListener(eventName, unhighlight, false);
      });
      
      // 处理文件拖拽
      fileListDiv.addEventListener('drop', handleDrop, false);
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight(e) {
        fileListDiv.classList.add('drag-over');
      }
      
      function unhighlight(e) {
        fileListDiv.classList.remove('drag-over');
      }
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        handleFiles(files);
      }
      
      async function handleFiles(files) {
        const fileArray = Array.from(files);
        
        console.log('=== 拖拽文件处理 ===');
        console.log('拖拽文件数量:', fileArray.length);
        
        // 修复：使用 Electron 的 webUtils.getPathForFile() 获取拖拽文件路径
        const filePaths = [];
        
        for (let i = 0; i < fileArray.length; i++) {
          const file = fileArray[i];
          let filePath = file.path;
          
          // 如果 path 为 undefined，使用 webUtils.getPathForFile() 获取路径
          if (!filePath && window.electronAPI && window.electronAPI.getPathForFile) {
            try {
              filePath = await window.electronAPI.getPathForFile(file);
              console.log(`文件 ${i + 1}: ${file.name} -> 路径获取成功`);
            } catch (error) {
              console.log(`文件 ${i + 1}: ${file.name} -> 路径获取失败:`, error);
            }
          }
          
          if (filePath) {
            filePaths.push(filePath);
          } else {
            console.log(`文件 ${i + 1}: ${file.name} -> 无法获取路径`);
          }
        }
        
        if (filePaths.length === 0) {
          showAlert('无法获取拖拽文件的路径，请使用"选择文件"按钮', 'danger');
          return;
        }
        
        try {
          const { validFiles, invalidFiles } = await window.electronAPI.validateVideoFiles(filePaths);
          
          if (validFiles.length > 0) {
            selectedFiles = validFiles;
            updateFileListDisplay(validFiles);
            
            if (invalidFiles.length > 0) {
              const invalidNames = invalidFiles.map(path => path.split(/[/\\]/).pop());
              showAlert(
                `成功添加 ${validFiles.length} 个视频文件。忽略了 ${invalidFiles.length} 个不支持的文件：${invalidNames.join(', ')}`,
                'warning'
              );
            } else {
              showAlert(`成功添加 ${validFiles.length} 个视频文件`, 'success');
            }
          } else {
            if (invalidFiles.length > 0) {
              const invalidNames = invalidFiles.map(path => path.split(/[/\\]/).pop());
              showAlert(
                `不支持的文件格式：${invalidNames.join(', ')}。请选择视频文件（${SUPPORTED_VIDEO_EXTENSIONS.join(', ')}）`,
                'danger'
              );
            }
          }
        } catch (error) {
          console.error('文件验证失败:', error);
          showAlert('文件验证失败，请重试', 'danger');
        }
      }
    }
    
    // 初始化所有下拉菜单并填充默认值
    function initializeDropdowns() {
      const history = getHistory();
      
      fieldNames.forEach(fieldName => {
        updateDropdown(fieldName);
        
        // 如果有历史记录，填充最近使用的值（第一个）
        if (history[fieldName] && history[fieldName].length > 0) {
          const lastUsedValue = history[fieldName][0];
          document.getElementById(fieldName).value = lastUsedValue;
        }
      });
    }
    
    // 进度管理器类
    class ProgressManager {
      constructor() {
        this.modal = null;
        this.progressBar = null;
        this.progressText = null;
        this.currentFile = null;
        this.successCount = null;
        this.errorCount = null;
        this.remainingCount = null;
        this.progressLog = null;
        this.isCancelled = false;
      }
      
      init() {
        this.modal = new bootstrap.Modal(document.getElementById('progressModal'));
        this.progressBar = document.getElementById('progress-bar');
        this.progressText = document.getElementById('progress-text');
        this.currentFile = document.getElementById('current-file');
        this.successCount = document.getElementById('success-count');
        this.errorCount = document.getElementById('error-count');
        this.remainingCount = document.getElementById('remaining-count');
        this.progressLog = document.getElementById('progress-log');
        
        // 取消按钮事件
        document.getElementById('cancel-operation').addEventListener('click', () => {
          this.cancel();
        });
        
        // 完成按钮事件
        document.getElementById('close-progress').addEventListener('click', () => {
          this.close();
        });
      }
      
      show(totalFiles) {
        this.isCancelled = false;
        this.reset();
        this.remainingCount.textContent = totalFiles;
        this.progressText.textContent = `0 / ${totalFiles}`;
        this.modal.show();
        
        // 启用取消按钮
        document.getElementById('cancel-operation').disabled = false;
        document.getElementById('close-progress').style.display = 'none';
      }
      
      updateProgress(current, total, fileName) {
        if (this.isCancelled) return;
        
        const percentage = Math.round((current / total) * 100);
        this.progressBar.style.width = `${percentage}%`;
        this.progressBar.setAttribute('aria-valuenow', percentage);
        this.progressText.textContent = `${current} / ${total}`;
        this.currentFile.textContent = fileName;
        this.remainingCount.textContent = total - current;
      }
      
      updateCounts(success, error) {
        this.successCount.textContent = success;
        this.errorCount.textContent = error;
      }
      
      addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-muted';
        const logEntry = document.createElement('div');
        logEntry.className = `small ${logClass}`;
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        this.progressLog.appendChild(logEntry);
        this.progressLog.scrollTop = this.progressLog.scrollHeight;
      }
      
      complete() {
        this.currentFile.textContent = '处理完成';
        this.progressBar.classList.remove('progress-bar-animated');
        
        // 禁用取消按钮，显示完成按钮
        document.getElementById('cancel-operation').disabled = true;
        document.getElementById('close-progress').style.display = 'inline-block';
        
        this.addLog('所有文件处理完成', 'success');
      }
      
      cancel() {
        this.isCancelled = true;
        this.currentFile.textContent = '操作已取消';
        this.addLog('用户取消了操作', 'error');
        this.complete();
      }
      
      close() {
        this.modal.hide();
      }
      
      reset() {
        this.progressBar.style.width = '0%';
        this.progressBar.classList.add('progress-bar-animated');
        this.successCount.textContent = '0';
        this.errorCount.textContent = '0';
        this.remainingCount.textContent = '0';
        this.progressLog.innerHTML = '';
        this.currentFile.textContent = '准备开始...';
      }
    }
    
    // 创建进度管理器实例
    const progressManager = new ProgressManager();
    
    // 字段验证器
    class FieldValidator {
      static validateField(fieldName, value) {
        const field = document.getElementById(fieldName);
        let isValid = true;
        let message = '';
        
        switch (fieldName) {
          case 'product':
          case 'template':
          case 'video':
          case 'author':
            if (!value || value.trim().length === 0) {
              isValid = false;
              message = '此字段不能为空';
            } else if (value.trim().length > 50) {
              isValid = false;
              message = '字段长度不能超过50个字符';
            } else if (!/^[a-zA-Z0-9\u4e00-\u9fa5_-]+$/.test(value.trim())) {
              isValid = false;
              message = '只能包含字母、数字、中文、下划线和连字符';
            }
            break;
          case 'duration':
            const num = parseFloat(value);
            if (!value || isNaN(num) || num <= 0) {
              isValid = false;
              message = '必须是大于0的数字';
            } else if (num > 1000) {
              isValid = false;
              message = '制作时长不能超过1000小时';
            }
            break;
        }
        
        // 更新字段样式
        field.classList.remove('field-valid', 'field-invalid', 'field-warning');
        if (isValid) {
          field.classList.add('field-valid');
        } else {
          field.classList.add('field-invalid');
        }
        
        // 更新工具提示
        field.title = message || '';
        
        return { isValid, message };
      }
      
      static validateAllFields() {
        const fields = ['product', 'template', 'video', 'author', 'duration'];
        let allValid = true;
        const errors = [];
        
        fields.forEach(fieldName => {
          const value = document.getElementById(fieldName).value;
          const result = this.validateField(fieldName, value);
          if (!result.isValid) {
            allValid = false;
            errors.push(`${fieldName}: ${result.message}`);
          }
        });
        
        return { allValid, errors };
      }
    }
    
    // 批量重命名功能
    async function performBatchRename(selectedFileIds) {
      const filesToRename = selectedFileIds.map(fileId => {
        const index = parseInt(fileId.replace('file-', ''));
        return previewData[index];
      }).filter(item => item && item.originalPath);
      
      if (filesToRename.length === 0) {
        showAlert('没有可重命名的文件', 'warning');
        return;
      }
      
      // 显示确认对话框
      const confirmed = await showConfirmDialog(filesToRename);
      if (!confirmed) return;
      
      // 开始重命名过程
      previewManager.isProcessing = true;
      progressManager.show(filesToRename.length);
      
      const fields = previewManager.getFormFields();
      const options = { useNumberSuffix: document.getElementById('useNumberSuffix').checked };
      
      let successCount = 0;
      let errorCount = 0;
      
      for (let i = 0; i < filesToRename.length; i++) {
        if (progressManager.isCancelled) break;
        
        const item = filesToRename[i];
        const fileId = selectedFileIds[i];
        
        progressManager.updateProgress(i + 1, filesToRename.length, item.originalName);
        progressManager.addLog(`正在处理: ${item.originalName}`);
        
        // 更新文件状态为处理中
        previewManager.fileStates.set(fileId, 'processing');
        previewManager.updateFileStatus(fileId, 'processing');
        
        try {
          const result = await window.electronAPI.renameFiles({
            files: [item.originalPath],
            fields,
            options
          });
          
          if (result && result[0] && result[0].success) {
            successCount++;
            previewManager.fileStates.set(fileId, 'success');
            previewManager.updateFileStatus(fileId, 'success');
            progressManager.addLog(`✓ ${item.originalName} 重命名成功`, 'success');
          } else {
            errorCount++;
            previewManager.fileStates.set(fileId, 'error');
            previewManager.updateFileStatus(fileId, 'error');
            const error = result && result[0] ? result[0].error : '未知错误';
            progressManager.addLog(`✗ ${item.originalName} 重命名失败: ${error}`, 'error');
          }
        } catch (error) {
          errorCount++;
          previewManager.fileStates.set(fileId, 'error');
          previewManager.updateFileStatus(fileId, 'error');
          progressManager.addLog(`✗ ${item.originalName} 重命名失败: ${error.message}`, 'error');
        }
        
        progressManager.updateCounts(successCount, errorCount);
        
        // 短暂延迟以显示进度
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      progressManager.complete();
      previewManager.isProcessing = false;
      previewManager.updateBatchToolbar();
      
      // 显示结果摘要
      if (successCount > 0) {
        showAlert(`重命名完成：${successCount} 个文件成功${errorCount > 0 ? `，${errorCount} 个文件失败` : ''}`,
                  errorCount > 0 ? 'warning' : 'success');
      } else {
        showAlert('重命名失败，请检查文件权限或路径', 'danger');
      }
    }
    
    // 显示确认对话框
    function showConfirmDialog(filesToRename) {
      return new Promise((resolve) => {
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const confirmSummary = document.getElementById('confirm-summary');
        const confirmCheckbox = document.getElementById('confirm-checkbox');
        const confirmBtn = document.getElementById('confirm-rename');
        
        // 生成摘要
        let summaryHtml = `
          <div class="mb-3">
            <strong>即将重命名 ${filesToRename.length} 个文件：</strong>
          </div>
          <div class="list-group" style="max-height: 200px; overflow-y: auto;">
        `;
        
        filesToRename.forEach(item => {
          summaryHtml += `
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <span class="text-muted small">${item.originalName}</span>
                <i class="bi bi-arrow-right mx-2"></i>
                <span class="small">${item.previewName}</span>
              </div>
            </div>
          `;
        });
        
        summaryHtml += '</div>';
        confirmSummary.innerHTML = summaryHtml;
        
        // 重置状态
        confirmCheckbox.checked = false;
        confirmBtn.disabled = true;
        
        // 确认复选框事件
        confirmCheckbox.onchange = () => {
          confirmBtn.disabled = !confirmCheckbox.checked;
        };
        
        // 确认按钮事件
        confirmBtn.onclick = () => {
          modal.hide();
          resolve(true);
        };
        
        // 模态框关闭事件
        document.getElementById('confirmModal').addEventListener('hidden.bs.modal', () => {
          resolve(false);
        }, { once: true });
        
        modal.show();
      });
    }
    
    document.getElementById('select-files').addEventListener('click', async () => {
      console.log('=== 按钮选择文件 ===');
      
      const files = await window.electronAPI.selectFiles();
      console.log('按钮选择文件数量:', files ? files.length : 0);
      
      selectedFiles = files;
      updateFileListDisplay(files);
      
      if (files && files.length > 0) {
        showAlert(`成功选择 ${files.length} 个视频文件`, 'success');
      }
    });
    
    document.getElementById('clear-fields').addEventListener('click', async () => {
      // 清空所有输入字段
      fieldNames.forEach(fieldName => {
        document.getElementById(fieldName).value = '';
      });
      // 取消勾选复选框
      document.getElementById('useNumberSuffix').checked = false;
      showAlert('已清空所有字段', 'info');
      
      // 刷新预览
      await previewManager.refreshPreview();
    });
    
    document.getElementById('rename-files').addEventListener('click', async () => {
      if (!selectedFiles || selectedFiles.length === 0) {
        showAlert('请先选择文件！', 'danger');
        return;
      }
      
      const product = document.getElementById('product').value.trim();
      const template = document.getElementById('template').value.trim();
      const video = document.getElementById('video').value.trim();
      const author = document.getElementById('author').value.trim();
      const duration = document.getElementById('duration').value.trim();
      const useNumberSuffix = document.getElementById('useNumberSuffix').checked;
      
      if (!product || !template || !video || !author || !duration) {
        showAlert('请填写所有字段！', 'danger');
        return;
      }
      
      // 验证制作时长是否为有效数字
      if (isNaN(parseFloat(duration)) || parseFloat(duration) <= 0) {
        showAlert('制作时长必须是大于0的数字！', 'danger');
        return;
      }
      
      // 保存到历史记录
      addToHistory('product', product);
      addToHistory('template', template);
      addToHistory('video', video);
      addToHistory('author', author);
      addToHistory('duration', duration);
      
      const fields = { product, template, video, author, duration };
      const options = { useNumberSuffix };
      
      const result = await window.electronAPI.renameFiles({ files: selectedFiles, fields, options });
      
      // 显示重命名结果
      let html = '';
      result.forEach(r => {
        if (r.success) {
          const suffixInfo = r.videoSuffix ? `（视频名添加后缀：${r.videoSuffix}）` : '（无后缀）';
          html += `
            <tr class="table-success">
              <td class="preview-filename">${r.oldPath.split(/[/\\]/).pop()}</td>
              <td class="preview-filename">${r.newPath.split(/[/\\]/).pop()}</td>
              <td class="text-center">
                <i class="bi bi-check-circle text-success" title="重命名成功 ${suffixInfo}"></i>
              </td>
            </tr>
          `;
        } else {
          html += `
            <tr class="table-danger">
              <td class="preview-filename">${r.oldPath.split(/[/\\]/).pop()}</td>
              <td class="preview-filename text-danger">重命名失败</td>
              <td class="text-center">
                <i class="bi bi-x-circle text-danger" title="错误：${r.error}"></i>
              </td>
            </tr>
          `;
        }
      });
      
      // 更新预览表格显示结果
      previewManager.previewTableBody.innerHTML = html;
      
      // 显示成功消息
      const successCount = result.filter(r => r.success).length;
      const failCount = result.filter(r => !r.success).length;
      if (successCount > 0) {
        showAlert(`重命名完成：${successCount} 个文件成功${failCount > 0 ? `，${failCount} 个文件失败` : ''}`,
                  failCount > 0 ? 'warning' : 'success');
      } else {
        showAlert('重命名失败，请检查文件权限或路径', 'danger');
      }
      
      // 清空选择的文件
      selectedFiles = [];
      previewData = [];
    });

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      const container = document.querySelector('.container');
      container.insertBefore(alertDiv, container.firstChild);
      
      // 自动关闭提示
      setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alertDiv);
        bsAlert.close();
      }, 3000);
    }
    
    // 添加表单字段变更监听器
    function setupFormFieldListeners() {
      // 防抖函数，避免频繁更新
      let debounceTimer;
      const debounceDelay = 500; // 500ms延迟
      
      function debouncedRefresh() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          previewManager.refreshPreview();
        }, debounceDelay);
      }
      
      // 为所有表单字段添加监听器
      fieldNames.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        field.addEventListener('input', debouncedRefresh);
        field.addEventListener('change', debouncedRefresh);
      });
      
      // 为复选框添加监听器
      document.getElementById('useNumberSuffix').addEventListener('change', debouncedRefresh);
    }
    
    // 添加新的事件监听器
    function setupNewEventListeners() {
      // 预览控制按钮事件
      document.getElementById('refresh-preview').addEventListener('click', () => {
        previewManager.refreshPreview();
      });
      
      document.getElementById('select-all').addEventListener('click', () => {
        document.getElementById('select-all-checkbox').checked = true;
        previewManager.toggleSelectAll();
      });
      
      document.getElementById('deselect-all').addEventListener('click', () => {
        document.getElementById('select-all-checkbox').checked = false;
        previewManager.toggleSelectAll();
      });
      
      // 全选复选框事件
      document.getElementById('select-all-checkbox').addEventListener('change', () => {
        previewManager.toggleSelectAll();
      });
      
      // 批量操作按钮事件
      document.getElementById('batch-rename').addEventListener('click', () => {
        const selectedFileIds = Array.from(previewManager.selectedFiles);
        if (selectedFileIds.length > 0) {
          performBatchRename(selectedFileIds);
        }
      });
      
      document.getElementById('batch-retry').addEventListener('click', () => {
        const errorFileIds = [];
        previewManager.fileStates.forEach((state, fileId) => {
          if (state === 'error') {
            errorFileIds.push(fileId);
          }
        });
        
        if (errorFileIds.length > 0) {
          // 选中所有失败的文件
          previewManager.selectedFiles.clear();
          errorFileIds.forEach(fileId => {
            previewManager.selectedFiles.add(fileId);
          });
          
          // 更新界面
          document.querySelectorAll('.file-checkbox').forEach(checkbox => {
            checkbox.checked = errorFileIds.includes(checkbox.dataset.fileId);
            previewManager.updateRowSelection(checkbox.dataset.fileId, checkbox.checked);
          });
          
          previewManager.updateBatchToolbar();
          previewManager.updateSelectAllCheckbox();
          
          // 执行批量重命名
          performBatchRename(errorFileIds);
        }
      });
      
      // 字段验证事件
      const fieldNames = ['product', 'template', 'video', 'author', 'duration'];
      fieldNames.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        
        // 实时验证
        field.addEventListener('input', (e) => {
          FieldValidator.validateField(fieldName, e.target.value);
        });
        
        field.addEventListener('blur', (e) => {
          FieldValidator.validateField(fieldName, e.target.value);
        });
      });
      
      // 键盘快捷键支持
      document.addEventListener('keydown', (e) => {
        // Ctrl+A 全选
        if (e.ctrlKey && e.key === 'a' && previewData.length > 0) {
          e.preventDefault();
          document.getElementById('select-all-checkbox').checked = true;
          previewManager.toggleSelectAll();
        }
        
        // Enter 确认重命名（当有选中文件时）
        if (e.key === 'Enter' && previewManager.selectedFiles.size > 0 && !previewManager.isProcessing) {
          e.preventDefault();
          const selectedFileIds = Array.from(previewManager.selectedFiles);
          performBatchRename(selectedFileIds);
        }
        
        // Escape 取消选择
        if (e.key === 'Escape' && previewManager.selectedFiles.size > 0) {
          e.preventDefault();
          document.getElementById('select-all-checkbox').checked = false;
          previewManager.toggleSelectAll();
        }
      });
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      initializeDropdowns();
      setupDragAndDrop();
      setupFormFieldListeners();
      setupNewEventListeners();
      progressManager.init();
      
      // 初始化工具提示
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      console.log('第二阶段功能初始化完成：批量操作、状态管理、进度显示、错误处理优化');
    });
  </script>
</body>
</html>
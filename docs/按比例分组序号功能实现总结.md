# 按视频比例分组序号功能实现总结

## 功能概述

实现了按视频比例分组添加序号的功能，不同视频比例（如916、169）分别独立计算序号。

## 修改内容

### 1. fileRenamer.js 修改

#### 新增函数：calculateRatioGroupIndexes()
- **功能**：按视频比例分组并计算每个文件在其比例组内的序号
- **参数**：filePaths - 文件路径数组
- **返回**：Map<number, number> - 文件索引到比例组内序号的映射
- **逻辑**：
  1. 获取所有文件的比例信息，按比例分组
  2. 为每个比例组分配序号（组内第一个文件序号为0，第二个为1，以此类推）

#### 修改函数：renameFiles()
- **变更**：使用 `calculateRatioGroupIndexes()` 计算比例组内序号
- **优化**：避免重复计算视频尺寸，提高性能
- **结果**：每个比例组内独立计算序号

### 2. main.js 修改

#### 更新导入
- 新增导入 `calculateRatioGroupIndexes` 函数

#### 修改 get-file-metadata 处理程序
- **变更**：使用按比例分组的序号逻辑生成预览
- **新增字段**：ratioGroupIndex - 文件在比例组内的序号
- **日志优化**：显示比例和组内序号信息

#### 修改 detect-filename-conflicts 处理程序
- **变更**：使用按比例分组的序号逻辑检测冲突
- **一致性**：确保冲突检测与实际重命名逻辑一致

## 功能效果

### 示例场景
输入文件：
- 3个916尺寸视频 + 3个169尺寸视频
- 视频名都输入"Text"

### 期望结果
**916尺寸组：**
- Text（第1个，无序号）
- Text2（第2个）
- Text3（第3个）

**169尺寸组：**
- Text（第1个，无序号，重新从1开始计数）
- Text2（第2个）
- Text3（第3个）

## 技术实现细节

### 分组逻辑
1. **第一步**：遍历所有文件，获取视频尺寸和比例
2. **第二步**：按比例分组，每个比例维护一个文件列表
3. **第三步**：为每个比例组内的文件分配序号（0, 1, 2, ...）
4. **第四步**：在重命名时使用比例组内序号而非全局序号

### 序号规则
- 每个比例组内第一个文件（序号0）：不添加数字后缀
- 每个比例组内后续文件（序号1+）：添加数字后缀（2, 3, 4, ...）

### 性能优化
- `calculateRatioGroupIndexes()` 函数只计算一次所有文件的比例分组
- 避免在重命名过程中重复计算视频尺寸

## 兼容性

### 向后兼容
- 保持原有的文件命名格式
- 保持原有的API接口不变
- 撤回功能正常工作

### 预览一致性
- 预览界面显示的文件名与实际重命名结果完全一致
- 冲突检测使用相同的序号逻辑

## 测试建议

### 测试用例
1. **基本功能测试**
   - 3个916 + 3个169视频，验证序号独立计算
   - 单一比例多个文件，验证序号连续性

2. **边界情况测试**
   - 只有一个比例的文件
   - 混合多种比例（916、169、11、45等）
   - 文件名冲突处理

3. **性能测试**
   - 大量文件的处理速度
   - 内存使用情况

4. **一致性测试**
   - 预览与实际重命名结果对比
   - 冲突检测准确性验证

## 代码位置

### 主要修改文件
- `fileRenamer.js`：核心重命名逻辑
- `main.js`：IPC处理程序和预览逻辑

### 关键函数
- `calculateRatioGroupIndexes()`：比例分组计算
- `renameFiles()`：文件重命名主函数
- `get-file-metadata`：预览生成
- `detect-filename-conflicts`：冲突检测